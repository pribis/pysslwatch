server {
server_name  bellastationery.com www.bellastationery.com artisanstationers.com;
  root    /var/www/boxcar/htdocs;
  access_log  /var/www/boxcar/logs/access.log  main;
  error_log /var/www/boxcar/logs/error.log;
  client_max_body_size 0; 
  userid         on;
  userid_name    bxcp;
  userid_domain  bellastationery.com;
  userid_path    /;
  userid_expires 365d;
#  userid_p3p     'policyref="/w3c/p3p.xml", CP="CUR ADM OUR NOR STA NID"';

    auth_basic     "Restricted";
    auth_basic_user_file auth/stage;
  keepalive_timeout 70;



  # images and static resources
  location		~* \.(?:ico|css|js|gif|jpe?g|png|mp3|wav)$ {
    expires 10M;
    add_header Pragma public;
    add_header Cache-Control "public, must-revalidate,proxy-revalidate";
  }

  # images, etc.
  location              ~* \.(?:ico|css|js|gif|jpe?g|png|mp3|wav|woff)$ {
    add_header          Pragma public;
    add_header          Cache-Control "public, must-revalidate,proxy-revalidate";
    expires             max;
    ## IMAGES TO FORWARD GO HERE
    #blog images, now at the CDN
    rewrite             /letterpress-inspiration/wp-content/uploads/(.*) https://d3fdwk8mzutvyj.cloudfront.net/uploads/$1 permanent;

    # images from old site that are worth keeping around
    rewrite             /images/calligraphy/(.*) https://d3fdwk8mzutvyj.cloudfront.net/calligraphy/$1 permanent;
    rewrite             /images/designs/(.*) https://d3fdwk8mzutvyj.cloudfront.net/designs/$1 permanent;
    rewrite             /images/galleries/(.*) https://d3fdwk8mzutvyj.cloudfront.net/galleries/$1 permanent;
  }

  location ^~ /chat {
      rewrite ^/chat(.*) https://chat.bellastationery.com$1 permanent;
  }

  location ^~ /apple-touch-icon {
   log_not_found off;
   access_log off;
  }



  location ~ /wp-login.php {
     # if they've visited the site before, they should have a uid cookie.                
     # this cookie does not exist here when the first request comes in.                  
     # this way we can segregate brute force login attempts from valid ones.             
     if ($http_cookie !~* "bxcp") {                                                      
        set $test "A";                                                                   
     }                                                                                   
     if ($request_method ~* "POST") {                                                    
        set $test "${test}B";                                                            
     }                                                                                   
                                                                                         
     # crazy workaround is a quick way to make two conditions...                         
     if ($test = "AB" ){
     	return 403;
     }
     fastcgi_pass            php8.3-fpm;
     fastcgi_keep_conn       on;
     fastcgi_index           index.php;
}   

  ## WordPress network files
  location ~ ^/files/(.*)$ {

    # if we need to send this to an error_page, $1 is blank. but if we set a new variable, it survives intact.
    set $filereq $1;

    try_files /wp-content/blogs.dir/$blogid/files/$filereq?$args /wp-includes/ms-files.php?file=$filereq;
    expires 7d;
    add_header Cache-Control "public, must-revalidate, proxy-revalidate";
  }




  location ^~ /patterns {
    internal;
    alias /var/www/boxcar/trunk/cache/patterns;
  }



  #avoid php readfile()
  location ^~ /blogs.dir {
    internal;
    alias /var/www/boxcar/htdocs/wp-content/blogs.dir;
    access_log off;log_not_found off;expires max;
  }
        
  location ~ /favicon.ico {
    log_not_found off;
    access_log off;
  }

  location ~ /robots.txt {
    allow all;
    log_not_found off;
    access_log off;
  }

  # script and style minification
  location ^~ /min/ {
    rewrite ^/min/ /wp-content/plugins/bwp-minify/min/?$args last;
  }



 
#  location ~ ^/account/+. {
#    rewrite ^/account/(.*) /account/#$1 permanent;
#  }

  location ~ (\.php) {
    fastcgi_pass            php8.3-fpm;
    fastcgi_keep_conn       on;
    fastcgi_index           index.php;

    if ($ssl_protocol != "") {
       rewrite ^/wp-activate.php http://$server_name/wp-activate.php?$args permanent;
    }
   # rewrite ^/photopolymer-supplies/letterpress-plates-steel.php /shop/category/photopolymer-sheets/steel-backed/ permanent;
  }





 location /http-bind/ {
    proxy_pass http://127.0.0.1:5280/http-bind/;
    proxy_buffering off;
    tcp_nodelay on;
  }

  location ~ ^/rest/(.*)$ {
    default_type application/json;
    rewrite ^.* /wp-content/plugins/boxcar-rest/request-handler.php;
    # error_page 404 = /wp-content/plugins/boxcar-rest/request-handler.php?$args;
  }

  ## FORCE SSL HERE
  if ($ssl_protocol = "") {
     ## I think WP is currently enforcing this okay. Will need to update when account page is updated.
  }

  location ^~ /client/{
     rewrite ^/client/(.*) /smock_client/$1 permanent;
  }

  # LEGACY PAGES
  location              ~* \.html$ {
    rewrite             ^/letterpress/([\w-]+)\.html$ /designs/$1/ permanent;
    rewrite             ^/letterpress/about/our-story.html? /us/ permanent;
    rewrite             ^/letterpress/order/what-we-can-do.html? /what-we-can-do/ permanent;
    rewrite             ^/letterpress/eco/green-printing.html? /green-printing/ permanent;
    rewrite             ^/letterpress/order/access.html? /wp-login.php permanent;
    rewrite             ^/letterpress/order/faqs.html? /faqs/ permanent;
    rewrite             ^/letterpress/order/service.html? /personal-shopper/ permanent;
    rewrite             ^/letterpress/order/promotions.html? /promotions/ permanent;
    rewrite             ^/contact/contact.html? /contact/ permanent;
    rewrite             ^/letterpress-wedding-invitations.html? /letterpress-wedding-invitations/ permanent;
    rewrite             ^/vintage-wedding-invitations.html? /vintage-wedding-invitations/ permanent;
    rewrite             ^/modern-wedding-invitations.html? /modern-wedding-invitations/ permanent;
    rewrite             ^/destination-wedding-invitations.html? /destination-wedding-invitations/ permanent;
    rewrite             ^/gold-wedding-invitations.html? /gold-wedding-invitations/ permanent;
    rewrite             ^/formal-wedding-invitations.html? /formal-wedding-invitations/ permanent;
    rewrite             ^/unique-wedding-invitations.html? /unique-wedding-invitations/ permanent;
    rewrite             ^/calligraphy-wedding-invitations.html? /calligraphy-wedding-invitations/ permanent;
    rewrite             ^/beach-wedding-invitations.html? /beach-wedding-invitations/ permanent;
    rewrite             ^/bilingual-international-letterpress.html? /bilingual-international-wedding-invitations/ permanent;
    rewrite             ^/letterpress-wedding-response-cards.html? /response-cards/ permanent;
    rewrite             ^/letterpress-wedding-response-postcards.html? /response-cards/ permanent;
    rewrite             ^/letterpress/etiquette/wedding-response-card-wording.html? /response-cards/ permanent;
    rewrite             ^/letterpress-reception-cards.html? /reception-cards/ permanent;
    rewrite             ^/letterpress/etiquette/wedding-reception-wording.html? /reception-cards/ permanent;
    rewrite             ^/letterpress-direction-accommodation-cards.html? /direction-accommodations/ permanent;
    rewrite             ^/letterpress/etiquette/wedding-direction-card-wording.html? /direction-accommodations/ permanent;
    rewrite             ^/letterpress/etiquette/accommodation-card-wording.html? /direction-accommodations/ permanent;
    rewrite             ^/wedding-postage-stamps.html? /customize/postage-addressing/ permanent;
    rewrite             ^/letterpress/etiquette/web-site-card-wording.html? /website-cards/ permanent;
    rewrite             ^/letterpress/etiquette/events-card-wording.html? /event-cards/ permanent;
    rewrite             ^/foil-stamped-wedding-invitations.html? /foil-feature-wedding-invitations/ permanent;
    rewrite             ^/letterpress-bar-mitzvah-invitations.html? /bar-mitzvah/ permanent;
    rewrite             ^/letterpress-bat-mitzvah-invitations.html? /bat-mitzvah/ permanent;
    rewrite             ^/letterpress-save-the-date-cards.html? /save-the-dates/ permanent;
    rewrite             ^/letterpress/etiquette/save-the-date-wording.html? /save-the-dates/ permanent;
    rewrite             ^/letterpress-coasters.html? /coasters/ permanent;
    rewrite             ^/letterpress/etiquette/coaster-wording.html? /coasters/ permanent;
    rewrite             ^/letterpress-program-covers.html? /wedding-programs/ permanent;
    rewrite             ^/letterpress/etiquette/wedding-program-cover-wording.html? /wedding-programs/ permanent;
    rewrite             ^/letterpress/etiquette/wedding-program-wording.html? /wedding-programs/ permanent;
    rewrite             ^/letterpress-programs.html? /wedding-programs/ permanent;
    rewrite             ^/letterpress-menus.html? /menus/ permanent;
    rewrite             ^/letterpress/etiquette/reception-menu-wording.html? /menus/ permanent;
    rewrite             ^/letterpress/etiquette/favor-tag-etiquette.html? /favor-cards/ permanent;
    rewrite             ^/letterpress-place-cards.html? /escort-place-cards/ permanent;
    rewrite             ^/letterpress-folded-place-cards.html? /escort-place-cards/ permanent;
    rewrite             ^/letterpress-flat-stationery.html? /stationery/ permanent;
    rewrite             ^/letterpress-folded-stationery.html? /stationery/ permanent;
    rewrite             ^/letterpress/etiquette/thank-you-card-wording.html? /stationery/ permanent;
    rewrite             ^/letterpress/customize/?$ /customize/ permanent;
    rewrite             ^/letterpress/customize/fonts.html? /customize/fonts/ permanent;
    rewrite             ^/letterpress/customize/inks.html? /customize/printing-methods/ permanent;
    rewrite             ^/letterpress/customize/foil-stamping-colors.html? /customize/printing-methods/ permanent;
    rewrite             ^/letterpress/customize/papers.html? /customize/papers-envelopes/ permanent;
    rewrite             ^/letterpress/customize/edge-painting.html? /customize/edging/ permanent;
    rewrite             ^/letterpress/customize/foil-edging.html? /customize/edging/ permanent;
    rewrite             ^/letterpress/customize/wedding-envelopes.html? /customize/papers-envelopes/ permanent;
    rewrite             ^/letterpress/customize/envelope-liners-metallic.html? /customize/envelope-liners/ permanent;
    rewrite             ^/letterpress/customize/envelope-lining.html? /customize/envelope-liners/ permanent;
    rewrite             ^/letterpress/customize/pocketfolds.html? /customize/papers-envelopes/ permanent;
    rewrite             ^/letterpress/customize/wedding-motifs.html? /customize/motifs-monograms/ permanent;
    rewrite             ^/letterpress/customize/custom-invitations.html? /customize/custom-artwork/ permanent;
    rewrite             ^/letterpress/customize/design.html? /customize/custom-artwork/ permanent;
    rewrite             ^/letterpress/customize/custom-maps.html? /customize/custom-artwork/ permanent;
    rewrite             ^/letterpress/customize/calligraphy-addressing.html? /customize/postage-addressing/ permanent;
    rewrite             ^/letterpress/eco/causes-we-support.html? /causes-we-support/ permanent;
    rewrite             ^/letterpress/about/letterpress-newsletter.html? /promotions/ permanent;
    rewrite             ^/letterpress/order/find-a-dealer.html? /find-us/ permanent;
    rewrite             ^/wedding-tips-and-advice.html? /tips/ permanent;
    rewrite             ^/letterpress/etiquette/wedding-invitation-wording.html? /wedding-invitation-etiquette/ permanent;
    rewrite             ^/real-weddings.html? /pressd/category/real-weddings/ permanent;
    rewrite             ^/green-weddings.html? /pressd/category/green-weddings/ permanent;
    rewrite             ^/letterpress/order/baby-announcements.html? /baby-announcements/ permanent;
    rewrite             ^/letterpress/about/staff.html? /us/ permanent;
    rewrite             ^/letterpress/order/why.html? /why/ permanent;
    rewrite             ^/contact/visit-us.html? /visit-us/ permanent;
    rewrite             ^/letterpress/about/become-a-dealer.html? /become-a-dealer/ permanent;
    rewrite             ^/sitemap.html? /sitemap_index.xml permanent;
    rewrite             ^/designers/barr.html? /designers/barr/ permanent;
    rewrite             ^/designers/giordano.html? /designers/twobrunettes/ permanent;
    rewrite             ^/designers/dean.html? /designers/ditto/ permanent;
    rewrite             ^/designers/laatsch.html? /designers/ permanent;
    rewrite             ^/designers/black.html? /designers/black/ permanent;
    rewrite             ^/designers/decker.html? /designers/racheal/ permanent;
    rewrite             ^/designers/tierney.html? /designers/jessica/ permanent;
    rewrite             ^/designers/zeinert.html? /designers/debi/ permanent;
    rewrite             ^/designers/kamal.html? /designers/kamal/ permanent;
    rewrite             ^/designers/stigler.html? /designers/stigler/ permanent;
    rewrite             ^/designers/seal.html? /designers/bethann/ permanent;
    rewrite             ^/designers/whitla.html? /designers/whitla/ permanent;
    rewrite             ^/designers/mumau.html? /designers/mumau/ permanent;
    rewrite             ^/designers/oboyle.html? /designers/oboyle/ permanent;
    rewrite             ^/designers/hanna.html? /designers/hanna/ permanent;
    rewrite             ^/designers/aragona.html? /designers/lindsy/ permanent;
    rewrite             ^/designers/jang.html? /designers/jang/ permanent;
    rewrite             ^/designers/bertsch.html? /designers/bertsch/ permanent;
    rewrite             ^/designers/hische.html? /designers/hische/ permanent;
    rewrite             ^/designers/gaulthier.html? /designers/gauthier/ permanent;
    rewrite             ^/designers/snow.html? /designers/snow/ permanent;
    rewrite             ^/designers/hogan.html? /designers/hogan/ permanent;
    rewrite             ^/designers/maybelle.html? /designers/ permanent;
    rewrite             ^/designers/mandel.html? /designers/mandel/ permanent;
    rewrite             ^/designers/koenig.html? /designers/koenig/ permanent;
    rewrite             ^/designers/walroth.html? /designers/sarah/ permanent;
    rewrite             ^/designers/wong.html? /designers/ permanent;
    rewrite             ^/designers/mccarter.html? /designers/mccarter/ permanent;
    rewrite             ^/designers/grieshaber.html? /designers/ permanent;
    rewrite             ^/designers/heidi.html? /designers/ permanent;
    rewrite             ^/letterpress/order/international.html? /international/ permanent;
    rewrite             ^/letterpress/order/wedding-suite.html? /wedding-suite/ permanent;
    rewrite             ^/letterpress/order/pricing.html? /pricing/ permanent;
    rewrite             ^/letterpress/order/shipping.html? /shipping/ permanent;
    rewrite             ^/letterpress/order/samples.html? /samples/ permanent;
    rewrite             ^/letterpress/customize/monograms.html? /customize/motifs-monograms/ permanent;
    rewrite             ^/letterpress/customize/sizes.html? /customize/sizes-shapes/ permanent;
    rewrite             ^/letterpress/customize/make-unique-wedding-invitations.html? /customize/ permanent;
    rewrite             ^/letterpress/customize/corner-rounding.html? /customize/sizes-shapes/ permanent;
    rewrite             ^/letterpress/customize/die-cuts.html? /customize/sizes-shapes/ permanent;
    rewrite             ^/letterpress/customize/calligraphy.html? /customize/calligraphy/ permanent;
    rewrite             ^/letterpress/hailey-modern.html? /designs/hailey-modern/ permanent;
    rewrite             ^/letterpress/customize/letterpress.html? /customize/printing-methods/ permanent;
    rewrite             ^/letterpress/customize/foil-stamping.html? /customize/printing-methods/ permanent;
    rewrite             ^/letterpress/customize/custom-postage-stamps.html? /customize/postage-addressing/ permanent;
    rewrite             ^/letterpress/customize/eco-wedding-invitations-specs.html? /customize/additional-customizations/ permanent;
    rewrite             ^/letterpress/customize/grommeting.html? /customize/additional-customizations/ permanent;
  }


  # this is for all locations that didn't match any other location strings
  location              / {

    #random
    rewrite             ^/designers/virginialucashart-gmail-com/? /designers/virginialucashart/ permanent;
    rewrite             ^/designers/gaulthier/? /designers/gauthier/ permanent;
    rewrite             ^/custom[/]?$ /designs/custom-design/ permanent;
    rewrite             ^/designs/custom[/]?$ /designs/custom-design/ permanent;
    rewrite             ^/designs/antebellum[/]? /designs/calyx/ permanent;
    rewrite             ^/invite[/]?$ /invitational-bella-figura/ permanent;
    rewrite             ^/the-invitational[/]?$ /invitational/ permanent;
    rewrite             ^/bar-mitzvah[/]?$ /bar-mitzvah-invitations/ permanent;
    rewrite             ^/bat-mitzvah[/]?$ /bat-mitzvah-invitations/ permanent;
    rewrite             ^/whats-new-(.*)$ /new-$1 permanent;
    rewrite             ^/preorder[/]?$ /new-wedding-invitations/ permanent;
    rewrite             ^/nyc/?$ /new-york-city-store/ permanent;
    rewrite             ^/NYC/?$ /new-york-city-store/ permanent;
    rewrite             ^/book/?$ /new-york-city-store/ permanent;
    rewrite             ^/new-york-city-store/appointment/?$ /new-york-city-store/manhattan/ permanent;
    rewrite             ^/new-york-invitations/lion-in-the-sun-brooklyn/?$ /new-york-city-store/brooklyn/ permanent;
    rewrite             ^/order-form/?$ https://d1mkprg9bp64fp.cloudfront.net/wp-content/blogs.dir/3/files/2015/01/bella-client-2015-order-form-editable.pdf last;

    rewrite             ^/dealer-application/?$ https://d1mkprg9bp64fp.cloudfront.net/wp-content/blogs.dir/3/files/2013/02/2017-bella-album-order-form-with-application.pdf last;

    rewrite             ^/dealer-application-order-form/?$ https://d1mkprg9bp64fp.cloudfront.net/wp-content/blogs.dir/3/files/2013/02/2017-bella-album-order-form-with-application.pdf last;
    rewrite             ^/dealer-custom-order-form/?$ https://d1mkprg9bp64fp.cloudfront.net/wp-content/blogs.dir/3/files/2016/01/bella-dealer-2016-order-form-editable.pdf last;
    rewrite             ^/dealer-sample-proof/?$ https://d1mkprg9bp64fp.cloudfront.net/wp-content/blogs.dir/3/files/2015/01/bella-store-sample-FINAL.pdf last;
    rewrite             ^/ink-decoder/?$ https://d1mkprg9bp64fp.cloudfront.net/wp-content/blogs.dir/3/files/2014/01/2013-bella-ink-decoder.pdf last;
    rewrite             ^/font-decoder/?$ https://d1mkprg9bp64fp.cloudfront.net/wp-content/blogs.dir/3/files/2015/08/bella-dealer-font-list.pdf last;
    rewrite             ^/pricing-pdf/?$ https://d1mkprg9bp64fp.cloudfront.net/wp-content/blogs.dir/3/files/2013/02/2016_retail_pricing.pdf last;

    rewrite             ^/album-order-form/?$ https://d1mkprg9bp64fp.cloudfront.net/wp-content/blogs.dir/3/files/2016/11/2017-bella-album-order-form-regular.pdf last;
    rewrite             ^/postage-rate-calculator/?$ https://d1mkprg9bp64fp.cloudfront.net/wp-content/blogs.dir/3/files/2014/01/2011-bella-resource-binder-postage-rates-brides.pdf last;
    rewrite             ^/hebrew-key/?$ https://d1mkprg9bp64fp.cloudfront.net/wp-content/blogs.dir/3/files/2014/01/hebrew-key-bella-figura.pdf last;
    rewrite             ^/assembling/?$ https://www.bellafigura.com/pressd/envelope-sealing/ last;

    # woo to gallery
    rewrite             ^/shop/?$ /wedding-invitations/ permanent;

    # old blog
    rewrite             ^/letterpress-inspiration/?$ /pressd/ permanent;
    rewrite             ^/letterpress-inspiration/\d+/\d+/(.*) /pressd/$1 permanent;
    rewrite             ^/letterpress-inspiration/(.*) /pressd/$1 permanent;
    rewrite             ^/pressd/\d+/\d+/(.*) /pressd/$1 permanent;

    # random non-.html old pages
    rewrite             ^/trendsetters/?.* /samples/ permanent;
    rewrite             ^/albums/?.* /favorites/ permanent;
    rewrite             ^/order-form-2024   https://drive.google.com/file/d/1qcRTOFozBUsu0nx2M_7ein9jAtKbTGZ6/view?usp=sharing last;
    proxy_set_header    X-Forwarded-Host $http_host;
    try_files           $uri $uri/ /index.php$is_args$args;
  }



    listen 443 ssl;
    http2 on; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/dev.bxp.cc/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/dev.bxp.cc/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot


}

server {
    if ($host = www.bellastationery.com) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


    if ($host = bellastationery.com) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


listen 80;
server_name  bellastationery.com www.bellastationery.com;
    return 404; # managed by Certbot




}
