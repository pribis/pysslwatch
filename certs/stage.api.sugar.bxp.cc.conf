server{

    server_name    stage.api.sugar.bxp.cc;
    root          /var/www/sugar-api/public;
    access_log    /var/www/sugar-api/storage/logs/access.log  main;
    error_log     /var/www/sugar-api/storage/logs/error.log;
    client_max_body_size 0;
    userid         on;
    userid_name    stage_bxpcc_dev;
    userid_domain  stage.api.sugar.bxp.cc;
    userid_path    /;
    userid_expires 365d;
    keepalive_timeout 70;
    index index.php index.html index.htm;

    # API can only handle requests from this domain
    # set $app_origin "https://stage.api.bxp.cc";
    set $app_origin "*";

    location ~ ^/.well-known/acme-challenge(.*) {
       allow all;
       alias /var/www/certbot/.well-known/acme-challenge$1;
    }

    location ~ /favicon.ico {
        log_not_found off;
        access_log off;
    }

    location ~ /robots.txt {
        allow all;
        log_not_found off;
        access_log off;
    }

    location / {

        if ($request_method = 'OPTIONS') {
	  add_header Access-Control-Allow-Origin $app_origin always;
	  add_header Access-Control-Allow-Credentials true always;
	  add_header Access-Control-Allow-Methods GET,POST,PUT,OPTIONS,DELETE always;
	  add_header Access-Control-Allow-Headers DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type always;

	  add_header Access-Control-Max-Age 1728000;
	  add_header Content-Type 'text/plain charset=UTF-8';
	  return 204;
	}
											
	add_header Access-Control-Allow-Origin $app_origin always;
	add_header Access-Control-Allow-Credentials true always;
	add_header Access-Control-Allow-Methods GET,POST,PUT,OPTIONS,DELETE always;
	add_header Access-Control-Allow-Headers DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type always;
	try_files $uri $uri/ /index.php?$query_string;
    }

    location ~ \.php$ {
        add_header Access-Control-Allow-Origin $app_origin always;
	add_header Access-Control-Allow-Credentials true always;
	add_header Access-Control-Allow-Methods GET,POST,PUT,OPTIONS,DELETE always;
	add_header Access-Control-Allow-Headers DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type always;
	
        try_files $uri /index.php =404;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass php-fpm;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }


    listen 443 ssl;
    http2 on; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/dev.bxp.cc/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/dev.bxp.cc/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot







}

server{
    if ($host = stage.api.sugar.bxp.cc) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


    listen 80;

    server_name    stage.api.sugar.bxp.cc;
    return 404; # managed by Certbot


}