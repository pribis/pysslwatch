server {
  server_name 	 brian.boxcarpress.us;
  root		/home/brian/projects/work/boxcar/trunk;
  access_log	/home/brian/projects/work/boxcar/logs/access.log  main;
  error_log	/home/brian/projects/work/boxcar/logs/error.log;
  client_max_body_size 0;	
  userid         on;
  userid_name    brian_bxcp;
  userid_domain  brian.boxcarpress.us;
  userid_path    /;
  userid_expires 365d;
  keepalive_timeout 70;

  auth_basic     "Restricted";
  auth_basic_user_file /home/brian/projects/work/boxcar/auth/stage;

  # botnet login protection
  location ~ /wp-login.php {
     # if they've visited the site before, they should have a uid cookie.                
     # this cookie does not exist here when the first request comes in.                  
     # this way we can segregate brute force login attempts from valid ones.             
     if ($http_cookie !~* "bxcp") {                                                      
        set $test "A";                                                                   
     }                                                                                   
     if ($request_method ~* "POST") {                                                    
        set $test "${test}B";                                                            
     }                                                                                   
                                                                                         
     # crazy workaround is a quick way to make two conditions...                         
     if ($test = "AB" ){                                                                 
        return 403;                                                                      
     }                                                                                   
                                                                                         
     fastcgi_pass            php8.3-fpm.brian;                                                    
     fastcgi_keep_conn       on;                                                         
     fastcgi_index           index.php;                                                  
  }   

  ## WordPress network files
  location ~ /files/(.*)$ {
    try_files /wp-content/blogs.dir/$blogid/$uri /wp-includes/ms-files.php?file=$1 ;
    expires 7d;
    add_header Cache-Control "public, must-revalidate, proxy-revalidate";
  }

  # location ~ ^/rest/(.*)$ {
  #  default_type application/json;
  #  # avoid cache serve of POST/PUT/DELETE/PATCH requests

  #  if ($request_method = POST ) {
  #    set $memcached_request 0;
  #  }

  #  if ( $memcached_request = 1) {
  #    add_header X-Cache-Engine "REST cache via nginx";
  #    memcached_pass memcached-servers;
  #   }
  #  if ( $memcached_request = 0 ){
  #   rewrite ^.* /wp-content/plugins/boxcar-rest/request-handler.php?$args;
  #  }
  #  error_page 404 = /wp-content/plugins/boxcar-rest/request-handler.php?$args;
  #}

  # try to get result from memcached
  #  location @memcached {
  #    default_type text/html;
  #    set $memcached_key data-$scheme://$host$request_uri;
  #    set $memcached_request 1;
  #
  #    # exceptions
  #    # avoid cache serve of POST requests
  #    if ($request_method = POST ) {
  #      set $memcached_request 0;
  #    }
  #
  #    # avoid cache serve of wp-admin-like pages, starting with "wp-"
  #    if ( $uri ~ "/wp-" ) {
  #      set $memcached_request 0;
  #    }
  #
  #    # avoid cache serve of any URL with query strings
  #    if ( $args ) {
  #      set $memcached_request 0;
  #    }
  #
  #    # avoid cache for logged in users
  #    if ($http_cookie ~* "woocommerce_cart_|comment_author_|wordpressuser_|wp-postpass_" ) {
  #        set $memcached_request 0;
  #    }
  #
  #      if ( $memcached_request = 1) {
  #        add_header X-Cache-Engine "WP-FFPC via nginx";
  #        memcached_pass memcached-servers;
  #        error_page 404 = @rewrites;
  #      }
  #
  #      # this means the page is not supposed to be cached (ie, has query string, user is logged in, etc)
  #      if ( $memcached_request = 0 ) {
  #        rewrite ^ /index.php last;
  #      }
  #    }

     
  location = /favicon.ico {
    log_not_found off;
    access_log off;
  }

  location ~ ^/rest/(.*)$ {
    default_type application/json;
    rewrite ^.* /wp-content/plugins/boxcar-rest/request-handler.php?$args;
    error_page 404 = /wp-content/plugins/boxcar-rest/request-handler.php?$args;
  }

  location = /robots.txt {
    allow all;
    log_not_found off;
    access_log off;
  }

  # avoid php readfile()
  location ^~ /blogs.dir {
    internal;
    alias /home/brian/projects/work/boxcar/trunk/wp-content/blogs.dir ;
    access_log off; log_not_found off;  expires max;
  }


  location ^~ /auth/ {
    rewrite ^/auth/(.*) /wp-content/themes/boxcar2012/auth/$1?$args last;
  }

  # script and style minification
  location ^~ /min/ {
    rewrite ^/min/ /wp-content/plugins/bwp-minify/min/?$args last;
  }

  # images from our old blog were throwing 404 errors
  location ~ /us/blog/wp-content/.* {
    rewrite ^/us/blog/wp-content/(.*) /wp-content/$1 permanent;
  }

  # old blog
  location ~ /us/blog/.* {
    rewrite ^/us/blog/(.*) /blog/$1 permanent;
  }

  # this is for all locations that didn't match any other location strings
  location / {
    # This is cool because no php is touched for static content. 
    # include the "?$args" part so non-default permalinks doesn't break when using query string

    try_files $uri $uri/ /index.php$is_args$args; 
    index index.php;
  }


  location ~ (\.php|php-fpm-status) {
    fastcgi_pass            php8.3-fpm.brian;
    fastcgi_keep_conn       on;
  }


  # location /http-bind/ {
  #    proxy_pass http://127.0.0.1:5280/http-bind/;
  #    proxy_buffering off;
  #    tcp_nodelay on;
  #  }

  # images
  location		~* \.(?:ico|css|js|gif|jpe?g|png)$ {

    rewrite ^/images/admin-bar-sprite.png /wp-includes/images/admin-bar-sprite.png?$args break;
    rewrite ^/images/(.*) /archive/images/$1 permanent;
    rewrite ^/letterpress/images/(.*) /archive/letterpress/images/$1 permanent;
    rewrite ^/platemaking/images/(.*) /archive/platemaking/images/$1 permanent;
    rewrite ^/photopolymer-supplies/images/(.*) /archive/photopolymer-supplies/images/$1 permanent;
    rewrite ^/boxcar-base/images/(.*) /archive/boxcar-base/images/$1 permanent;
    rewrite ^/us/images/(.*) /archive/us/images$1 permanent;
    rewrite ^/community/images/(.*) /archive/community/images/$1 permanent;
    rewrite ^/service/images/(.*) /archive/service/images/$1 permanent;

    expires max;
    add_header Pragma public;
    add_header Cache-Control "public, must-revalidate,proxy-revalidate";
  }

  rewrite ^/order-plates/(.+) https://$server_name/order-plates/#$1 permanent;
  rewrite ^/order-history/(.+) https://$server_name/order-history/#$1 permanent;


  location ~* \.html$  {
    rewrite ^/letterpress/letterpress-printing.html /how-letterpress-printing-works/ permanent;
    rewrite ^/letterpress/portfolio.html /letterpress-printing/ permanent;
    rewrite ^/letterpress/invitations/ /letterpress-printing/ permanent;
    rewrite ^/letterpress/reception/ /letterpress-printing/ permanent;
    rewrite ^/letterpress/fine-press/ /letterpress-printing/ permanent;
    rewrite ^/letterpress/posters/ /letterpress-printing/ permanent;
    rewrite ^/letterpress/identity/ /letterpress-printing/ permanent;
    rewrite ^/letterpress/stationery/ /letterpress-printing/ permanent;
    rewrite ^/letterpress/capabilities.html /letterpress-capabilities/ permanent;
    rewrite ^/letterpress/how-we-work.html /how-letterpress-printing-works/ permanent;
    rewrite ^/letterpress/letterpress-papers.html /letterpress-paper/ permanent;
    rewrite ^/letterpress/process.html /how-letterpress-printing-works/ permanent;
    rewrite ^/letterpress/designing-for-letterpress.html /letterpress-design-tips/ permanent;
    rewrite ^/letterpress/file-prep.html /letterpress-file-prep/ permanent;
    rewrite ^/boxcar-base/technology.html /boxcar-base/ permanent;
    rewrite ^/boxcar-base/choosing.html /letterpress-base-and-plates/ permanent;
    rewrite ^/boxcar-base/switching.html /lead-type-letterpress-plates/ permanent;
    rewrite ^/boxcar-base/switching-from-magnetic.html /magnetic-bases-boxcar-base/ permanent;
    rewrite ^/boxcar-base/switching-from-magnesium.html /magnesium-plates-letterpress-bases/ permanent;
    rewrite ^/boxcar-base/switching-from-lead-type.html /lead-type-letterpress-plates/ permanent;
    rewrite ^/boxcar-base/printing-manual.html /letterpress-printing-boxcar-base/ permanent;
    rewrite ^/boxcar-base/manual-locking.html /letterpress-printing-boxcar-base/ permanent;
    rewrite ^/boxcar-base/manual-print.html /letterpress-printing-boxcar-base/ permanent;
    rewrite ^/boxcar-base/manual-techniques.html /letterpress-printing-boxcar-base/ permanent;
    rewrite ^/boxcar-base/manual-questions.html /letterpress-printing-boxcar-base/ permanent;
    rewrite ^/boxcar-base/maintenance.html /letterpress-printing-boxcar-base/ permanent;
    rewrite ^/boxcar-base/guarantees.html /boxcar-base/ permanent;
    rewrite ^/boxcar-base/faqs.html /faqs/category/general-printing/ permanent;
    rewrite ^/boxcar-base/comments.html /contact-us/ permanent;
    rewrite ^/platemaking/why-boxcar.html /letterpress-plates/ permanent;
    rewrite ^/platemaking/comments.html /contact-us/ permanent;
    rewrite ^/platemaking/letterpress-sample.html /free-letterpress-plates/ permanent;
    rewrite ^/platemaking/essentials.html /letterpress-plates/ permanent;
    rewrite ^/platemaking/turnaround.html /letterpress-plates-pricing/ permanent;
    rewrite ^/platemaking/plate-choices.html /letterpress-plates-pricing/ permanent;
    rewrite ^/platemaking/guarantee.html /letterpress-plates/ permanent;
    rewrite ^/platemaking/polymer-tips.html /letterpress-design-tips/ permanent;
    rewrite ^/platemaking/faqs.html /faqs/category/platemaking/ permanent;
    rewrite ^/platemaking/letterpress-plate-recycling.html /letterpress-polymer-plate-recycling/ permanent;
    rewrite ^/photopolymer-supplies/letterpress-starter.html /letterpress-base-starter-packs/ permanent;
    rewrite ^/photopolymer-supplies/boxcar-base-starter.html /letterpress-base-starter-packs/ permanent;
    rewrite ^/photopolymer-supplies/letterpress-ink-starter.html /letterpress-inks-starter-packs/ permanent;
    rewrite ^/photopolymer-supplies/photopolymer-plates.html /letterpress-plates-unexposed/ permanent;
    rewrite ^/photopolymer-supplies/letterpress-ink.html /letterpress-ink/ permanent;
    rewrite ^/photopolymer-supplies/letterpress-ink-rubber.html /letterpress-ink-rubber-based permanent;
    rewrite ^/photopolymer-supplies/letterpress-ink-oil.html /letterpress-ink-oil-based permanent;
    rewrite ^/photopolymer-supplies/letterpress-ink-acrylic.html /letterpress-ink-oil-based permanent;
    rewrite ^/photopolymer-supplies/letterpress-ink-metallic.html /shop/metallic-letterpress-ink-starter-pack-oil-base/ permanent;
    rewrite ^/photopolymer-supplies/ink-additives.html /letterpress-ink-additives/ permanent;
    rewrite ^/photopolymer-supplies/pressroom.html /letterpress-supplies-for-printing/ permanent;
    rewrite ^/photopolymer-supplies/platemaking-supplies.html /photopolymer-platemaking/ permanent;
    rewrite ^/photopolymer-supplies/platemakers.html /shop/photopolymer-platemakers/ permanent;
    rewrite ^/photopolymer-supplies/boxcar-merchandise.html /letterpress-swag/ permanent;
    rewrite ^/photopolymer-supplies/tshirt-vandercook.html /shop/letterpress-t-shirt-vandercook/ permanent;
    rewrite ^/photopolymer-supplies/tshirt-candp.html /shop/letterpress-t-shirt-chandler-price/ permanent;
    rewrite ^/photopolymer-supplies/tshirt-heidelberg-platen.html /shop/lettepress-t-shirt-heidelberg-windmill/ permanent;
    rewrite ^/photopolymer-supplies/tshirt-sigwalt.html /shop/letterpress-t-shirt-sigwalk/ permanent;
    rewrite ^/photopolymer-supplies/printing-apron.html /shop/boxcar-press-printing-apron/ permanent;
    rewrite ^/photopolymer-supplies/faqs.html /faqs/category/supplies/ permanent;
    rewrite ^/platemaking/letterpress-plate-recycling.html /letterpress-polymer-plate-recycling/ permanent;
    rewrite ^/community/letterpress-training-video.html /letterpress-classes-videos/ permanent;
    rewrite ^/community/letterpress-links.html /blog/shop-talk/ permanent;
    rewrite ^/us/boxcar-history.html /about-us/ permanent;
    rewrite ^/us/mission.html /about-us/ permanent;
    rewrite ^/us/letterpress.html /presses/ permanent;
    rewrite ^/us/equipment.html /presses/ permanent;
    rewrite ^/us/environment.html /green-printing/ permanent;
    rewrite ^/us/environment-practices.html /green-printing/ permanent;
    rewrite ^/us/environment-goals.html /green-printing/ permanent;
    rewrite ^/us/blog /blog/ permanent;
    rewrite ^/us/visiting-boxcar.html /visit-us/ permanent;
    rewrite ^/service/shipping.html /customer-service/ permanent;
    rewrite ^/service/warranty.html /customer-service/ permanent;
    rewrite ^/service/sales-tax.html /customer-service/ permanent;
    rewrite ^/service/payment-terms.html /customer-service/ permanent;
    rewrite ^/service/account-application.html /account/ permanent;
    rewrite ^/service/privacy.html /privacy-and-security/ permanent;
    rewrite ^/service/feedback.html /contact-us/ permanent;
    rewrite ^/service/order-form-pdf.html /order-plates/ permanent;
    rewrite ^/service/faqs-service-supplies.html /faqs/category/customer-service-questions/ permanent;
    rewrite ^/service/contact.html /contact-us/ permanent;
    rewrite ^/us/chandler-and-price.html /presses/ permanent;
    rewrite ^/us/heidelberg-cylinder.html /presses/heidelberg-sbb-sbb34723/ permanent;
    rewrite ^/us/heidelberg-windmill.html /presses/heidelberg-GT60843E/ permanent;
    rewrite ^/us/vandercook-universal.html /presses/vandercook-universal-i/ permanent;
    rewrite ^/us/pearl-press.html /presses/pearl-11-improved/ permanent;
    rewrite ^/us/heidelberg-windmill2.html /presses/heidelberg-windmill-T169159E/ permanent;
    rewrite ^/us/board-shear.html /presses/ permanent;
    rewrite ^/us/vandercook-iii.html /presses/ permanent;
    rewrite ^/us/kraus-corner-rounder.html /presses/ permanent;
    rewrite ^/letterpress/invitations/.* /letterpress-printing/ permanent;
    rewrite ^/letterpress/reception/.* /letterpress-printing/ permanent;
    rewrite ^/letterpress/fine-press/.* /letterpress-printing/ permanent;
    rewrite ^/letterpress/posters/.* /letterpress-printing/ permanent;
    rewrite ^/letterpress/identity/.* /letterpress-printing/ permanent;
    rewrite ^/boxcar-base/index.html /boxcar-base/ permanent;
    rewrite ^/photopolymer-supplies/boxcar-credit-application.pdf /wp-content/uploads/2012/09/boxcar-credit-application.pdf permanent;
    rewrite ^/letterpress/index.html /how-letterpress-printing-works/ permanent;
    rewrite ^/photopolymer-supplies/index.html /shop/ permanent;
    rewrite ^/us/index.html /about-us/ permanent;
    rewrite ^/community/index.html /letterpress/ permanent;
    rewrite ^/service/order-form-pdf.html /shop/ permanent;
    rewrite ^/service/account-application.html /how-letterpress-supplies-work/ permanent;
    rewrite ^/us/visiting-boxcar.html /letterpress-shop-tours/ permanent;
    rewrite ^/community/letterpress-links.html /blog/category/shop-talk/ permanent;
    rewrite ^/community/flywheel.html https://letterpresscommons.com/original-press-manuals/ permanent;
  }



    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/brian.boxcarpress.us/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/brian.boxcarpress.us/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

}

server {
    if ($host = brian.boxcarpress.us) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


  server_name 	 brian.boxcarpress.us;
    listen 80;
    return 404; # managed by Certbot


}